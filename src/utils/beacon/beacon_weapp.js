function d(e,n,o){if(e[n]){var t=e[n];e[n]=function(e){o.call(this,e,n),t.call(this,e)}}else e[n]=function(e){o.call(this,e,n)}}function c(e,n,o){if(e[n]){var t=e[n];e[n]=function(e){var a=t.call(this,e);return o.call(this,[e,a],n),a}}else e[n]=function(e){o.call(this,e,n)}}function sh(e,n){if(void 0!==e&&void 0!==e[1]){wx.setStorageSync(beacon.prefix+"share",JSON.stringify(e[1]));var o=e[1].success;e[1].success=function(e){if("object"==typeof e.shareTickets){var n=(new Date).getTime(),t=getCurrentPages().pop().__route__,a=[{weappPageName:t,count:1,start:n,name:"beacon_shareappmessage",params:{}}],c=JSON.parse(wx.getStorageSync(beacon.prefix+"share"));c.shareTickets=JSON.stringify(e.shareTickets),request(4,n,0,[],a,null,encodeURIComponent(JSON.stringify(c)))}void 0!==o&&o(e)}}}function getTime(){return(new Date).getTime()}function getSystemInfo(){var e=wx.getSystemInfoSync();return e}function getRandom(e){var n=(1e6*new Date+Math.floor(1e6*Math.random())).toString(e);return n||""}function getUUID(){var e=wx.getStorageSync(beacon.prefix+beacon.u);return""==e&&(e=getRandom(36),wx.setStorageSync(beacon.prefix+beacon.u,e)),e}function getNetworkType(){return wx.getStorageSync(beacon.prefix+beacon.nt)||"4g"}function getLocation(){return beacon.conf.getLocation?wx.getStorageSync(beacon.prefix+beacon.lt)||"":""}function setLocation(){beacon.conf.getLocation&&wx.getLocation({type:beacon.conf.locationType||"wgs84",success:function(e){wx.setStorageSync(beacon.prefix+beacon.lt,JSON.stringify(e))}})}function getUserInfo(){return beacon.conf.getUserInfo?wx.getStorageSync(beacon.prefix+beacon.ui)||"":""}function setUserInfo(){beacon.conf.getUserInfo&&wx.getUserInfo({withCredentials:!1,success:function(e){var n=e.userInfo;n.nickName=encodeURIComponent(n.nickName),wx.setStorageSync(beacon.prefix+beacon.ui,JSON.stringify(n)),console.log("userInfo--->"+JSON.stringify(e.userInfo))},fail:function(e){console.log("userInfo fail--->"+e)}})}function initData(){null!=beacon.conf.channelId&&""!=beacon.conf.channelId||null==beacon.options||void 0===beacon.options.query||!beacon.options.query.hasOwnProperty("bea_channel_id")||(beacon.conf.channelId=beacon.options.query.bea_channel_id),beacon.serverUrl="https://"+(beacon.conf.isDebug?"jrlts":"otheve")+".beacon.qq.com/analytics/upload?tp=weapp",setLocation(),setUserInfo(),wx.getNetworkType({success:function(e){wx.setStorageSync(beacon.prefix+beacon.nt,e.networkType)}}),beacon.opid=wx.getStorageSync(beacon.prefix+beacon.oik),beacon.unid=wx.getStorageSync(beacon.prefix+beacon.uik)}function sendEvent(e,n,o,t){(!n||void 0===n||0>=n)&&(n=(new Date).getTime());var a=getCurrentPages(),c=0,i=[];a&&a.length>0&&(c=0===o?0:n-o,i=[{name:a.pop().__route__,start:n,duration:c,refer:""}]),request(e,n,c,i,t)}function request(e,n,o,t,a,c){(!n||void 0===n||0>=n)&&(n=(new Date).getTime());var i=[{type:2,data:{id:getRandom(32),start:n,status:e,duration:o||0,pages:t||[],events:a||[]}}],s=getSystemInfo(),r=getUUID();c&&void 0!==c&&""!=c||beacon.options&&(c=beacon.options.scene);var p={deviceId:r,appkey:beacon.conf.appKey,versionCode:beacon.conf.version,initTime:n,scene:c,channelID:beacon.conf.channelId,sdkVersion:beacon.sdkVersion,pixel:s.screenWidth+"*"+s.screenHeight+"*"+s.pixelRatio,language:s.language,model:encodeURIComponent(s.model),wxVersion:s.version,networkType:getNetworkType(),system:encodeURIComponent(s.system),platform:encodeURIComponent(s.platform),windowArea:s.windowWidth+"*"+s.windowHeight+"*"+s.pixelRatio,query:JSON.stringify(beacon.options),opid:beacon.opid,unid:beacon.unid,userInfo:getUserInfo(),location:getLocation(),msgs:i};wx.request({url:beacon.serverUrl,data:p,method:"POST"})}var beacon={options:null,serverUrl:null,opid:null,unid:null,conf:require("./beacon_weapp_conf.js"),prefix:"beacon_",sdkVersion:"weapp_v1.0.7",u:"u",ui:"ui",lt:"lt",nt:"nt",oik:"oik",uik:"uik",atl:0,ats:0,ptl:0,pts:0,appLaunch:function(){arguments.length>0&&null!=arguments[0]&&(beacon.options=arguments[0]),beacon.conf.beforeLoad(beacon.options),beacon.conf.appKey&&void 0!==beacon.conf.appKey&&beacon.conf.appKey.length>0&&beacon.conf.version&&void 0!==beacon.conf.version&&beacon.conf.version.length>0?(initData(),this.atl=getTime(),sendEvent(1,this.atl,0,[])):console.log("beacon_error:init data invalid")},appShow:function(){arguments.length>0&&null!=arguments[0]&&(beacon.options=arguments[0]),initData(),this.ats=getTime()},appHide:function(){},pageLoad:function(){var e=getCurrentPages().pop();this.ptl=getTime(),sendEvent(5,this.ptl,0,[]),beacon.conf.onPullDownRefresh&&!function(){var n=e.onPullDownRefresh;e.onPullDownRefresh=function(){beacon.onEvent("beacon_pulldownrefresh"),n.call(this,arguments)}}(),beacon.conf.onReachBottom&&!function(){var n=e.onReachBottom;e.onReachBottom=function(){beacon.onEvent("beacon_reachbottom"),n.call(this,arguments)}}()},pageUnload:function(){sendEvent(6,0,this.ptl,[])},pageShow:function(){this.pts=getTime(),sendEvent(2,this.pts,0,[])},pageHide:function(){sendEvent(4,0,this.pts,[])},onEvent:function(e,n){var o=(new Date).getTime(),t=getCurrentPages().pop().__route__,a=[{weappPageName:t,count:1,start:o,name:e,params:n||{}}];request(4,o,0,[],a)},setAppKey:function(e){beacon.conf.appKey=e},setChannelId:function(e){beacon.conf.channelId=e},setOpenid:function(e){e&&e.length>0&&(beacon.opid=e,wx.setStorageSync(beacon.prefix+beacon.oik,e))},setUnionid:function(e){e&&e.length>0&&(beacon.unid=e,wx.setStorageSync(beacon.prefix+beacon.uik,e))},setGetLocation:function(e){beacon.conf.getLocation=e===!0?!0:!1,e===!0&&setLocation()},setGetUserInfo:function(e){beacon.conf.getUserInfo=e===!0?!0:!1,e===!0&&setUserInfo()}},a=App;App=function(e){d(e,"onLaunch",beacon.appLaunch),d(e,"onShow",beacon.appShow),d(e,"onHide",beacon.appHide),a(e)};var p=Page;Page=function(e){d(e,"onLoad",beacon.pageLoad),d(e,"onUnload",beacon.pageHide),d(e,"onShow",beacon.pageShow),d(e,"onHide",beacon.pageHide),void 0!==e.onShareAppMessage&&c(e,"onShareAppMessage",sh),p(e)},module.exports=beacon;